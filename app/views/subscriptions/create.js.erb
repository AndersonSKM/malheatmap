(function () {
  document.querySelector('form').reset()

  App.consumer.subscriptions.create({ channel: 'SubscriptionChannel', process_id: '<%= @subscription.id %>' }, {
    connected () {
      document.querySelector('form').style.display = 'none'
      document.querySelector('.loader-container').innerHTML = '<%= j render(partial: "loader") %>'
    },

    received (data) {
      this.unsubscribe()

      if (data.status === 'success') {
        Turbolinks.visit(data.user_url, { action: 'advance' })
      } else {
        document.querySelector('form').style.display = ''
        document.querySelector('.loader-container').innerHTML = ''
        document.querySelector('.notifications-container').innerHTML = data.template
      }
    }
  })
}())

#!/bin/bash

set -e

THEDATE=`date +%d%m%y%H%M`

# Remove backups older than 31 days
find /var/www/_backups/malheatmap/* -mtime +31 -exec rm {} \;

BACKUP_FOLDER=/var/www/_backups/malheatmap/backup_${THEDATE}
mkdir ${BACKUP_FOLDER}

echo "Exporting databases"
sqlite3 /storage/malheatmap/malheatmap_primary_production.sqlite3 .schema > ${BACKUP_FOLDER}/schema.sql
sqlite3 /storage/malheatmap/malheatmap_primary_production.sqlite3 .dump > ${BACKUP_FOLDER}/dump.sql


echo "Compressing files"
tar -cavf ${BACKUP_FOLDER}.tar.gz ${BACKUP_FOLDER}/schema.sql ${BACKUP_FOLDER}/schema.sql

rm -rm ${BACKUP_FOLDER}

